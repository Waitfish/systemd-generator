// ============================================================================
// Systemd Service æ–‡ä»¶ç”Ÿæˆå™¨
// è¿™ä¸ªé¡¹ç›®ä¼šå¸®ä½ å­¦ä¹  Rust çš„æ ¸å¿ƒæ¦‚å¿µ
// ============================================================================

use clap::Parser;
use std::fs;
use std::io::{self};
use std::path::Path;

// ============================================================================
// ã€Rust æ¦‚å¿µ 1: ç»“æ„ä½“ (Struct) + å±æ€§å® (Derive Macro)ã€‘
// ============================================================================
// åœ¨ Python ä¸­ä½ å¯èƒ½ç”¨ dataclassï¼Œåœ¨ Go ä¸­æ˜¯ struct
// Rust çš„ struct ç±»ä¼¼ï¼Œä½†é…åˆ derive å®å¯ä»¥è‡ªåŠ¨å®ç°å¾ˆå¤šåŠŸèƒ½
//
// #[derive(Parser)] æ˜¯ä¸€ä¸ª"æ´¾ç”Ÿå®"ï¼Œè‡ªåŠ¨ä¸ºæˆ‘ä»¬å®ç° clap çš„å‘½ä»¤è¡Œè§£æ
// #[derive(Debug)] è®©ç»“æ„ä½“å¯ä»¥ç”¨ {:?} æ‰“å°è°ƒè¯•ä¿¡æ¯
#[derive(Parser, Debug)]
#[command(author, version, about = "ç”Ÿæˆ systemd service æ–‡ä»¶çš„å°å·¥å…·", long_about = None)]
struct Args {
    /// æœåŠ¡åç§°ï¼ˆä¾‹å¦‚ï¼šmyappï¼‰
    #[arg(short, long)]
    name: String,

    /// å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
    #[arg(short, long)]
    exec: String,

    /// æœåŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰
    #[arg(short, long, default_value = "My Service")]
    description: String,

    /// å·¥ä½œç›®å½•ï¼ˆå¯é€‰ï¼‰
    #[arg(short, long)]
    working_dir: Option<String>,

    /// è¿è¡Œç”¨æˆ·ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºå½“å‰ç”¨æˆ·ï¼‰
    #[arg(short, long)]
    user: Option<String>,

    /// è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤å½“å‰ç›®å½•ï¼‰
    #[arg(short, long)]
    output: Option<String>,
}

// ============================================================================
// ã€Rust æ¦‚å¿µ 2: ç»“æ„ä½“å®šä¹‰ - è¡¨ç¤º Service é…ç½®ã€‘
// ============================================================================
// è¿™ä¸ªç»“æ„ä½“å­˜å‚¨ systemd service çš„æ‰€æœ‰é…ç½®
// æ³¨æ„ Rust ä¸­å­—ç¬¦ä¸²ç±»å‹çš„åŒºåˆ«ï¼š
// - String: å¯å˜çš„ã€å †åˆ†é…çš„å­—ç¬¦ä¸²ï¼ˆç±»ä¼¼ Go çš„ stringï¼Œä½†å¯å˜ï¼‰
// - &str: å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œé€šå¸¸æ˜¯å€Ÿç”¨ï¼ˆä¸‹é¢ä¼šè®²ï¼‰
struct ServiceConfig {
    name: String,
    description: String,
    exec_start: String,
    working_directory: Option<String>,  // Option è¡¨ç¤ºå¯èƒ½æœ‰å€¼æˆ–æ²¡æœ‰å€¼ï¼ˆç±»ä¼¼ Go çš„æŒ‡é’ˆæˆ– Python çš„ Optionalï¼‰
    user: String,
}

// ============================================================================
// ã€Rust æ¦‚å¿µ 3: impl å— - ä¸ºç»“æ„ä½“å®ç°æ–¹æ³•ã€‘
// ============================================================================
// ç±»ä¼¼ Go çš„æ–¹æ³•æ¥æ”¶è€…æˆ– Python çš„ class æ–¹æ³•
// impl å—ç”¨äºä¸ºç±»å‹æ·»åŠ æ–¹æ³•
impl ServiceConfig {
    // ========================================================================
    // ã€Rust æ¦‚å¿µ 4: å…³è”å‡½æ•° (Associated Function)ã€‘
    // ========================================================================
    // new æ˜¯ä¸€ä¸ªå…³è”å‡½æ•°ï¼ˆæ²¡æœ‰ self å‚æ•°ï¼‰
    // ç±»ä¼¼ Python çš„ @classmethod æˆ– Go çš„æ™®é€šå‡½æ•°
    // è¿™æ˜¯ Rust çš„å‘½åçº¦å®šï¼Œç”¨ new åˆ›å»ºå®ä¾‹
    fn new(
        name: String,
        description: String,
        exec_start: String,
        working_directory: Option<String>,
        user: String,
    ) -> Self {  // Self æ˜¯å½“å‰ç±»å‹çš„åˆ«åï¼Œè¿™é‡ŒæŒ‡ ServiceConfig
        ServiceConfig {
            name,
            description,
            exec_start,
            working_directory,
            user,
        }
    }

    // ========================================================================
    // ã€Rust æ¦‚å¿µ 5: å€Ÿç”¨ (&self) - Rust æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€ã€‘
    // ========================================================================
    // &self è¡¨ç¤º"å€Ÿç”¨"selfï¼Œä¸è·å–æ‰€æœ‰æƒ
    // 
    // Rust çš„æ‰€æœ‰æƒç³»ç»Ÿï¼ˆOwnershipï¼‰ï¼š
    // 1. æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
    // 2. åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
    // 3. å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼ä¼šè¢«é‡Šæ”¾
    //
    // å€Ÿç”¨è§„åˆ™ï¼š
    // - &self: ä¸å¯å˜å€Ÿç”¨ï¼ˆåªè¯»ï¼‰ï¼Œå¯ä»¥æœ‰å¤šä¸ª
    // - &mut self: å¯å˜å€Ÿç”¨ï¼ˆå¯å†™ï¼‰ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª
    // - self: è·å–æ‰€æœ‰æƒï¼ˆä¼šç§»åŠ¨å€¼ï¼ŒåŸå˜é‡ä¸èƒ½å†ç”¨ï¼‰
    //
    // åœ¨ Go ä¸­ï¼Œæ–¹æ³•æ¥æ”¶è€…å¯ä»¥æ˜¯å€¼æˆ–æŒ‡é’ˆï¼Œä½† Go æœ‰ GC
    // åœ¨ Python ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å¼•ç”¨ï¼Œæœ‰ GC
    // Rust æ²¡æœ‰ GCï¼Œé€šè¿‡æ‰€æœ‰æƒç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶ä¿è¯å†…å­˜å®‰å…¨
    fn generate_service_content(&self) -> String {
        // format! å®ç±»ä¼¼ Python çš„ f-string æˆ– Go çš„ fmt.Sprintf
        let mut content = format!(
            "[Unit]\n\
             Description={}\n\
             After=network.target\n\
             \n\
             [Service]\n\
             Type=simple\n\
             User={}\n\
             ExecStart={}\n",
            self.description,
            self.user,
            self.exec_start
        );

        // ====================================================================
        // ã€Rust æ¦‚å¿µ 6: Option å’Œ æ¨¡å¼åŒ¹é…ã€‘
        // ====================================================================
        // Option<T> æ˜¯ Rust çš„æ ¸å¿ƒç±»å‹ï¼Œè¡¨ç¤ºå¯èƒ½æœ‰å€¼æˆ–æ— å€¼
        // - Some(value): æœ‰å€¼
        // - None: æ— å€¼
        //
        // è¿™æ›¿ä»£äº†å…¶ä»–è¯­è¨€çš„ null/nilï¼Œåœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶å¤„ç†ç©ºå€¼æƒ…å†µ
        // Python ä¸­ä½ å¯èƒ½ç”¨ if x is not None:
        // Go ä¸­ä½ å¯èƒ½ç”¨ if ptr != nil
        // Rust å¼ºåˆ¶ä½ å¿…é¡»å¤„ç† None çš„æƒ…å†µï¼Œå¦åˆ™ç¼–è¯‘ä¸é€šè¿‡
        if let Some(wd) = &self.working_directory {
            // if let æ˜¯æ¨¡å¼åŒ¹é…çš„ç®€åŒ–å½¢å¼
            // &self.working_directory æ˜¯å€Ÿç”¨ Option
            // Some(wd) åŒ¹é…æˆåŠŸæ—¶ï¼Œwd æ˜¯å†…éƒ¨å€¼çš„å¼•ç”¨
            content.push_str(&format!("WorkingDirectory={}\n", wd));
        }

        content.push_str(
            "Restart=always\n\
             RestartSec=5\n\
             \n\
             [Install]\n\
             WantedBy=multi-user.target\n"
        );

        content
    }

    // ========================================================================
    // ã€Rust æ¦‚å¿µ 7: Result ç±»å‹ - é”™è¯¯å¤„ç†ã€‘
    // ========================================================================
    // Result<T, E> æ˜¯ Rust çš„é”™è¯¯å¤„ç†æœºåˆ¶
    // - Ok(value): æˆåŠŸï¼ŒåŒ…å«ç»“æœå€¼
    // - Err(error): å¤±è´¥ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯
    //
    // Python ç”¨ try/exceptï¼ŒGo ç”¨è¿”å› (value, error)
    // Rust å¼ºåˆ¶ä½ å¤„ç†é”™è¯¯ï¼Œå¦åˆ™ç¼–è¯‘ä¸é€šè¿‡
    //
    // io::Result<()> æ˜¯ Result<(), io::Error> çš„ç®€å†™
    // () æ˜¯å•å…ƒç±»å‹ï¼Œè¡¨ç¤º"æ— è¿”å›å€¼"ï¼ˆç±»ä¼¼ Go çš„ç©ºè¿”å›æˆ– Python çš„ Noneï¼‰
    fn save_to_file(&self, output_path: Option<&str>) -> io::Result<()> {
        // ç”Ÿæˆæ–‡ä»¶å
        let filename = match output_path {
            // match æ˜¯ Rust çš„æ¨¡å¼åŒ¹é…ï¼ˆç±»ä¼¼ Go çš„ switch ä½†æ›´å¼ºå¤§ï¼‰
            Some(path) => path.to_string(),
            None => format!("{}.service", self.name),
        };

        // ç”Ÿæˆå†…å®¹
        let content = self.generate_service_content();

        // ====================================================================
        // ã€Rust æ¦‚å¿µ 8: ? æ“ä½œç¬¦ - é”™è¯¯ä¼ æ’­ã€‘
        // ====================================================================
        // ? æ˜¯é”™è¯¯ä¼ æ’­çš„è¯­æ³•ç³–
        // å¦‚æœ Result æ˜¯ Errï¼Œä¼šç«‹å³è¿”å›é”™è¯¯
        // å¦‚æœæ˜¯ Okï¼Œä¼šè§£åŒ…å€¼ç»§ç»­æ‰§è¡Œ
        //
        // ç­‰ä»·äº Go çš„ï¼š
        // if err != nil { return err }
        //
        // Python ä¸­éœ€è¦æ‰‹åŠ¨ try/except ç„¶å raise
        fs::write(&filename, content)?;

        // æ‰“å°æˆåŠŸæ¶ˆæ¯
        println!("âœ… Service æ–‡ä»¶å·²ç”Ÿæˆ: {}", filename);
        println!("ğŸ“‹ å®‰è£…æ­¥éª¤:");
        println!("   1. sudo mv {} /etc/systemd/system/", filename);
        println!("   2. sudo systemctl daemon-reload");
        println!("   3. sudo systemctl enable {}", self.name);
        println!("   4. sudo systemctl start {}", self.name);
        println!("   5. sudo systemctl status {}", self.name);

        Ok(())  // è¿”å›æˆåŠŸ
    }
}

// ============================================================================
// ã€Rust æ¦‚å¿µ 9: main å‡½æ•°å’Œè¿”å›ç±»å‹ã€‘
// ============================================================================
// main å‡½æ•°è¿”å› Resultï¼Œè¿™æ ·å¯ä»¥ç”¨ ? æ“ä½œç¬¦
// å¦‚æœè¿”å› Errï¼Œç¨‹åºä¼šæ‰“å°é”™è¯¯å¹¶ä»¥éé›¶çŠ¶æ€ç é€€å‡º
fn main() -> io::Result<()> {
    // è§£æå‘½ä»¤è¡Œå‚æ•°
    let args = Args::parse();

    // éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if !Path::new(&args.exec).exists() {
        // eprintln! è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯ï¼ˆç±»ä¼¼ Python çš„ print(..., file=sys.stderr)ï¼‰
        eprintln!("âŒ é”™è¯¯: å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {}", args.exec);
        eprintln!("ğŸ’¡ æç¤º: è¯·æä¾›å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„");
        std::process::exit(1);
    }

    // è·å–è¿è¡Œç”¨æˆ·ï¼šå¦‚æœç”¨æˆ·æŒ‡å®šäº†å°±ç”¨æŒ‡å®šçš„ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰ç”¨æˆ·
    let user = match args.user {
        Some(u) => u,
        None => {
            // å°è¯•ä»ç¯å¢ƒå˜é‡è·å–å½“å‰ç”¨æˆ·å
            std::env::var("USER").unwrap_or_else(|_| "root".to_string())
        }
    };

    // åˆ›å»ºé…ç½®
    let config = ServiceConfig::new(
        args.name,
        args.description,
        args.exec,
        args.working_dir,
        user,
    );

    // ========================================================================
    // ã€Rust æ¦‚å¿µ 10: å¼•ç”¨å’Œç”Ÿå‘½å‘¨æœŸã€‘
    // ========================================================================
    // args.output æ˜¯ Option<String>
    // as_deref() å°† Option<String> è½¬æ¢ä¸º Option<&str>
    // è¿™æ¶‰åŠåˆ°ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼ˆè¿™é‡Œç¼–è¯‘å™¨è‡ªåŠ¨æ¨æ–­ï¼‰
    //
    // &str æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼ˆå€Ÿç”¨ï¼‰ï¼Œæ¯” String æ›´è½»é‡
    // åœ¨å‡½æ•°å‚æ•°ä¸­ï¼Œé€šå¸¸ä¼˜å…ˆä½¿ç”¨ &str è€Œä¸æ˜¯ String
    config.save_to_file(args.output.as_deref())?;

    Ok(())
}

// ============================================================================
// ã€ç¼–è¯‘å’Œè¿è¡Œã€‘
// ============================================================================
// 1. ç¼–è¯‘é¡¹ç›®: cargo build --release
// 2. è¿è¡Œç¨‹åº: cargo run -- --name myapp --exec /usr/bin/myapp
// 
// æˆ–ç›´æ¥è¿è¡Œ:
// cargo run -- --name myapp --exec /usr/bin/python3 --description "æˆ‘çš„PythonæœåŠ¡"
//
// æŸ¥çœ‹å¸®åŠ©:
// cargo run -- --help
// ============================================================================

